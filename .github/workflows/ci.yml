name: CI

on:
  push:
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: ubuntu:24.04
    
    steps:
      - name: Install dependencies
        run: |
          dpkg --add-architecture i386
          apt update
          DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y \
            build-essential libbsd-dev libelf-dev libdw-dev binutils-dev zlib1g-dev \
            autoconf automake libtool pkg-config autoconf-archive \
            g++-10 gcc-10 lib32gcc-10-dev \
            ocaml ocamlbuild ocaml-findlib libnum-ocaml-dev \
            default-jdk-headless python3 \
            make git gawk gdb wget libc6-dbg \
            libunwind-dev libunwind-dev:i386 linux-libc-dev-i386-cross libc6-dev-i386 \
            libboost-iostreams-dev libboost-regex-dev \
            libboost-serialization-dev libboost-filesystem-dev libffi-dev \
            gettext-base
          cd /usr/bin && ln -sf gcc-10 gcc
          cd /usr/bin && ln -sf g++-10 g++
      
      - name: Report OCaml version for debugging
        run: |
          dpkg -l | grep ocaml
      
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Build submodules
        run: make -C contrib -j $(nproc)
      
      - name: Build project
        run: |
          . contrib/env.sh
          ./autogen.sh
          ./configure
          make -j $(nproc)
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .
            !.git
          retention-days: 1

  test:
    needs: build
    runs-on: ubuntu-24.04
    container:
      image: ubuntu:24.04
    
    steps:
      - name: Install dependencies
        run: |
          apt update
          DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y \
            ca-certificates make build-essential g++-10 autoconf automake libtool \
            libelf-dev python3 git gawk libunwind-dev \
            ocaml ocamlbuild ocaml-findlib \
            clang \
            libdw-dev binutils-dev libffi-dev \
            libboost-iostreams-dev libboost-regex-dev \
            libboost-serialization-dev libboost-filesystem-dev \
            pkg-config libglib2.0-dev
          cd /usr/bin && ln -sf gcc-10 gcc
          cd /usr/bin && ln -sf g++-10 g++
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .
      
      - name: Run tests
        run: make -C tests -k